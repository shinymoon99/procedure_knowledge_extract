UE-->NW：UE发起竞争性随机接入
UE<--NW：gNB回复MSG2（RAR）
UE-->NW：UE向gNB发送RRCSetupRequest消息，携带UE的InitialUE-Identity和EstablishmentCause，请求建立RRC连接，该消息对应于随机接入过程的Msg3
UE<--NW：gNB为UE分配并建立SRB1承载，并向UE发送RRCSetup消息
UE-->NW：UE向gNB发送RRCSetupComplete消息，RRC连接建立成功
RRC建立成功后，UE向gNodeB发送RRCSetupComplete，携带selectedPLMN-Identity、registeredAMF、s-nssai-list和NAS消息
gNodeB为UE分配专用的RAN-UE-NGAP-ID，根据selectedPLMN-Identity、registeredAMF、s-nssai-list选择AMF节点，然后将RRCSetupComplete消息中携带的NAS消息通过InitialUeMessage发送给AMF
gNodeB透传UE和AMF之间的NAS直传消息，完成IDENTITY查询、鉴权、NAS安全模式和注册过程。详见本文"7NAS流程"章节
AMF向gNodeB发送InitialContextSetupReq消息，启动初始上下文建立过程
gNodeB向UE发送SecurityModeCommand消息，通知UE启动完整性保护和加密过程
UE根据SecurityModeCommand消息指示的完整性保护和加密算法，派生出密钥，然后向gNodeB回复SecurityModeComplete消息。此后，启动上行加密
gNodeB向UE发送UECapabilityEnquiry消息，发起UE能力查询过程
UE向gNodeB回复UECapabilityInformation消息，携带UE能力信息
gNodeB向AMF发送UECapabilityInfolnd消息，透传UE能力
gNodeB向UE下发RRCReconfiguration消息，指示建立SRB2和DRB（DataRadioBearer）
UE收到RRCReconfiguration消息后，开始建立SRB2和DRB无线承载。建立成功后向gNodeB回复RRCReconfigurationComplete消息
gNodeB向AMF回复InitialContextSetupRsp消息
gNB为本端建立的RB承载PDCP协议实体配置相应的加密参数和完整性参数及密钥
gNB开始使能RRC完整性保护算法
gNB向UE发送SecurityModeCommand消息，该消息立即启动完整性保护，消息中包含加密算法和完整性保护算法选择
UE收到SecurityModeCommand消息后，根据消息中的算法选择派生密钥，校验消息中的MAC-I，然后返回SecurityModeComplete消息（含MAC-I）给gNB
gNB向UE发送UECapabilityEnquiry消息，发起UE能力查询过程
UE向gNodeB回复UECapabilityInformation消息，携带UE能力信息
gNodeB向AMF发送UECapabilityInfolnd消息，透传UE能力
AMF向gNB发送UEContextModificationRequest消息，触发UE上下文修改过程
gNB根据SecurityKeyIE信元派生出KgNB*，根据KgNB*进一步派生出KRRC-enc,KRRC-int,KUP-enc和KUP-int，向UE发送RRCReconfiguration消息，通知更新密钥
UE完成密钥更新后，向gNB回复RRCReconfigurationComplte消息
gNB向AMF回复UEContextModificationResponse消息，UE上下文修改完成
【可选】如果是gNB原因导致需要发起UE释放时，gNB向AMF发送UEContextReleaseRequest消息，触发UE上下文释放过程
AMF向gNB发送UEContextReleaseCommand消息，命令gNB释放UE上下文
gNB向UE发送RRCRelease消息，通知释放RRC连接
gNB向AMF回复UEContextReleaseComplete消息，同时释放本地资源
AMF向gNB发送PDUSESSIONRESOURCESETUPREQUEST消息，携带需要建立的PDU会话列表、每个PDU会话的QosFlow列表、以及每个QosFlow的质量属性等
gNB根据QosFlow的质量属性和MML界面配置的策略，将QosFlow映射到DRB，向UE发送RRCReconfiguration消息，发起建立DRB承载
UE完成DRB承载建立后，向gNB回复RRCReconfigurationComplte消息
gNB向AMF发送PDUSESSIONRESOURCESETUPRESPONSE消息，将成功建立的PDUSession信息写入PDUSessionResourceSetupResponseList信元中
AMF向gNB发送PDUSESSIONRESOURCEMODIFYREQUEST消息，携带需要增删的QoSFlowAddorModifyRequestList和QoSFlowtoReleaseList
gNB向UE发送RRCReconfiguration消息
UE向gNB回复RRCReconfigurationComplte消息
gNB向AMF发送PDUSESSIONRESOURCEMODIFYRESPONSE消息，将修改的信息写入PDUSessionResourceModifyResponseList信元中
【可选】gNB检测到NG-U传输故障后，先尝试重新分配新的NG-U地址，如果分配失败，则向核心网发送PDUSESSIONRESOURCENOTIFY，触发核心网发起PDU会话释放过程
AMF向gNB发送的PDUSESSIONRESOURCERELEASECOMMAND消息，携带需要删除的PDUSESSION列表
gNB向UE发送RRCReconfiguration消息，通知释放PDU会话
UE完成PDU会话释放后，向gNB回复RRCReconfigurationComplte消息
gNB发起该PDUSESSION对应的DRB承载和NG-U传输的删除操作，然后向AMF发送PDUSESSIONRESOURCERELEASERESPONSE响应消息
UE上报邻区测量报告
gNodeB根据测量报告携带的PCI，判决切换的目标小区与服务小区同属一个gNodeb并启动站内切换流程，目标小区根据UE源小区的上下文做准入判决
gNodeB-CU侧发送UECONTEXTSETUPREQUEST消息给gNodeB-DU，向gNodeB-DU侧为目标小区新申请用户资源
如果gNodeB-DU资源分配成功，回复UECONTEXTSETUPRESPONSE消息给gNodeB-CU
gNodeB-CU发送UECONTEXTMODIFICATIONREQUEST消息给gNodeB-DU，通知gNodeB-DU下发L2停止调度指示
gNodeB-DU回复UECONTEXTMODIFICATIONRESPONSE消息给gNodeB-CU
gNodeB给UE发送RRCReconfiguration消息携带切换的目标频点、PCI以及给UE配置的CRNTI和专用preamble
UE在目标小区发起非竞争的随机接入MSG1，携带专用preamble
gNodeB-DU侧回复MSG2RAR消息
UE给gNodeB回复RRCReconfigurationComplete，UE接入到目标小区
UE成功接入后释放源小区的上下文信息
UE上报邻区测量报告
gNodeB根据测量报告携带的PCI，判决切换的目标小区与服务小区同属一个gNodeB不同DU并启动同站跨DU内切换流程，目标小区根据UE源小区的上下文做准入判决
gNodeB-CU侧发送UECONTEXTSETUPREQUEST消息给目标gNodeB-DU，向目标gNodeB-DU侧为目标小区新申请用户资源
如果目标gNodeB-DU资源分配成功，回复UECONTEXTSETUPRESPONSE消息给gNodeB-CU
gNodeB-CU发送UECONTEXTMODIFICATIONREQUEST消息给源gNodeB-DU，通知gNodeB-DU下发L2停止调度指示
源gNodeB-DU回复UECONTEXTMODIFICATIONRESPONSE消息给gNodeB-CU
准入成功后，gNodeB给UE发送RRCReconfiguration消息携带切换的目标频点、PCI以及给UE配置的CRNTI和专用preamble
UE在目标小区发起非竞争的随机接入MSG1，携带专用preamble
目标gNodeB-DU侧回复MSG2RAR消息
UE给gNodeB回复RRCReconfigurationComplete，UE接入到目标小区
UE成功接入后释放源小区的上下文信息
gNodeB通过RRCReconfiguration向UE下发测量控制，包含测量对象（同频/异频），测量报告配置，GAP测量配置等
UE回复RRCReconfigurationComplete给gNodeB
UE根据收到的测量控制消息执行测量。UE测量并判定达到事件条件后，上报测量报告给gNodeB
gNodeB收到测量报告后，根据测量结果进行切换策略和目标小区/频点判决
源gNodeB向选择的目标小区所在的gNodeB发起切换请求
目标gNodeB收到切换请求后，进行准入控制，允许准入后分配UE实例和传输资源
目标gNodeB回复HANDOVERREQUESTACKNOWLEDGE给源gNodeB，允许切换入。如果有部分PDUSession切换入失败，消息中需要携带失败的PDUSession列表
源gNodeB发送RRCReconfiguration给UE，要求UE执行切换到目标小区
源gNodeB通过SNSTATUSTRANSFER将PDCPSN号发送给目标gNodeB
UE发送RRCReconfigurationComplete给目标gNodeB，UE空口切换到目标小区完成
目标gNodeB向AMF发送PATHSWITCHREQUEST消息通知UE已经改变小区，消息包含目标小区标识和所转换的PDUSession列表。核心网收到消息后，更新下行GTPU数据面，将RAN侧的GTPU地址修改为目标gNodeB
AMF向目标gNodeB响应PATHSWITCHREQUESTACKNOWLEDGE消息。如果AMF在PathSwitchRequestAck消息中指示核心网未能建立的PDUSession，则gNodeB删除未能建立的PDUSession
目标gNodeB向源gNodeB发送UECONTEXTRELEASE消息，源gNodeB释放已切换的用户
切换到目标小区后，gNodeB下发新小区的测量控制信息给UE
UE收到gNodeB下发新的测量控制后，回复RRCReconfigurationComplete
gNodeB通过RRCReconfiguration向UE下发测量控制，包含测量对象（同频/异频），测量报告配置，GAP测量配置等
UE回复RRCReconfigurationComplete给gNodeB
UE根据收到的测量控制消息执行测量。UE测量并判定达到事件条件后，上报测量报告给gNodeB
gNodeB收到测量报告后，根据测量结果进行切换策略和目标小区/频点判决
源gNodeB向NGC发送HANDOVERREQUIRED消息请求切换，消息包含目标gNodeBId、执行数据转发PDUSession列表等
NGC向指定的目标小区所在的gNodeB发起HANDOVERREQUEST切换请求，gNodeB根据消息中的TraceID、SPID识别出US用户
目标gNodeB收到切换请求后，进行准入控制，允许准入后分配UE实例和传输资源
目标gNodeB回复HANDOVERREQUESTACKNOWLEDGE给NGC，允许切换入。如果有部分PDUSession切换入失败，消息中需要携带失败的PDUSession列表
NGC向源gNodeB发送HANDOVERCOMMAND消息，消息中包含地址和用于转发的TEID列表，包含需要释放的承载列表
源gNodeB发送RRCReconfiguration给UE，要求UE执行切换到目标小区
源gNodeB将PDCPSN号通过UPLINKRANSTATUSTRANSFER发送给NGC
NGC再通过DOWNLINKRANSTATUSTRANSFER消息将PDCPSN号发送给目标gNodeB
UE发送RRCReconfigurationComplete给目标gNodeB，UE空口切换到目标小区完成
目标gNodeB发送HANDOVERNOTIFY给NGC，通知UE已经接入到目标小区，基于N2切换已经完成
切换到目标小区后，gNodeB下发新小区的测量控制信息给UE
UE收到gNodeB下发新的测量控制后，回复RRCReconfigurationComplete
NGC向源gNodeB发送UECONTEXTRELEASECOMMAND消息，源gNodeB释放切换的用户
源gNodeB向NGC回复UECONTEXTRELEASECOMPLETE
源gNodeB向NGC发送HANDOVERREQUIRED消息请求切换，消息包含(TargeteNBID,SourcetoTargetTransparentContainer,intersystemhandoverindication)等
NGC向发送EPC发送Relocationrequest
EPC向指定的目标小区所在的eNodeB发起HANDOVERREQUEST切换请求
目标eNodeB回复HANDOVERREQUESTACKNOWLEDGE给NGC，允许切换入。如果有部分E-RAB承载切换入失败，消息中需要携带失败的E-RAB承载列表
EPC回复Relocationresponse给NGC
NGC向源gNodeB发送HANDOVERCOMMAND消息，消息中包含地址和用于转发的TEID列表，包含需要释放的承载列表
源gNodeB发送RRCReconfiguration给UE，要求UE执行切换到目标小区
UE发送RRCReconfigurationComplete给目标gNodeB，UE空口切换到目标小区完成
目标eNodeB发送HANDOVERNOTIFY给EPC，通知UE已经接入到目标小区
EPC收到HANDOVERNOTIFY后给NGC发送RelocationCompleteNotification
NGC收到RelocationCompleteNotificationAck消息，向源gNodeB发送UECONTEXTRELEASECOMMAND消息，源gNodeB释放切换的用户
源eNodeB向EPC发送HANDOVERREQUIRED消息请求切换
EPC向NGC发送发送ForwardRelocationrequest
NGC向指定的目标小区所在的gNodeB发起HANDOVERREQUEST切换请求
目标gNodeB回复HANDOVERREQUESTACKNOWLEDGE给NGC，允许切换入。如果有部分承载切换入失败，消息中需要携带失败的承载列表
NGC回复ForwardRelocationresponse给EPC
EPC向源eNodeB发送HANDOVERCOMMAND消息，消息中包含地址和用于转发的TEID列表，包含需要释放的承载列表
源eNodeB发送RRCReconfiguration给UE，要求UE执行切换到目标小区
UE发送RRCReconfigurationComplete给目标gNodeB，UE空口切换到目标小区完成
目标gNodeB发送HANDOVERNOTIFY给NGC，通知UE已经接入到目标小区
NGC收到HANDOVERNOTIFY后给EPC发送ForwardRelocationCompleteNotification
EPC收到ForwardRelocationCompleteNotificationAck消息，向源eNodeB发起释放切换的用户